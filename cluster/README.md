# Kubernetes

## Tools needed for kubernetes

- age (generate key for sops): [https://github.com/FiloSottile/age]
- helm: [https://github.com/helm/helm]
- kubectl: [https://github.com/kubernetes/kubernetes]
- kustomize: [https://github.com/kubernetes-sigs/kustomize]
- sops (secret encryption): [https://github.com/getsops/sop]

## Naming conventions

- Each app's manifests are stored in a folder named like the app's namespace.

- Inside the folder I create subfolders for each type of resource and those
  subfolders contain yaml files with the name of the resource that they define.

  Exceptions are (files that are unique for each folder):
  - `namespace.yaml`: namespace config, useful to override pod security labels.
  - `kustomization.yaml`: declares what are the contents of the namespace.
  - `kustomization.flux.yaml`: indicates to flux that the namespace has to be
    deployed.

- All yaml files use the `.yaml` extension and not `.yml`.

- Persistent volumes storing data that needs to be backed up must have their
  name ending with `-data`, otherwise choose an appropriate suffix like `-cache`
  for other types of persistent data that doesn't need backups.

## Generated resources

Configmaps and secrets are automatically generated by kustomize. Their sources
are stored inside the `_generated` subdirectory of each app.

## Bootstrap

```sh
# 1. Get first node running.
# 2. Install cilium. (values are taken from the helmrelease file)
helm install -n cilium cilium cilium/cilium --values v.yaml
# 3. Apply coredns.
# 4. Apply fluxcd.
# 5. Apply blocky.
# 6. Apply cert-manager.
# 7. Apply cilium.
# 8. Repeat last steps until all circular dependencies are resolved.
```
